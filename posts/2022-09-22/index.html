<!doctype html><html lang=ja-jp>
<head>
<link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title> mitmproxyにおけるリクエスト編集の末尾改行文字の仕様 | Xrzheaven</title>
<link rel=canonical href=https://xrzhev.com/posts/2022-09-22/>
<meta name=description content="いろいろやっていき">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="all,follow">
<meta name=googlebot content="index,follow,snippet,archive">
<meta property="og:title" content="mitmproxyにおけるリクエスト編集の末尾改行文字の仕様">
<meta property="og:description" content="mitmproxyを使っていて「ん？」となる挙動があったので備忘として記録します。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://xrzhev.com/posts/2022-09-22/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-09-22T16:14:52+09:00">
<meta property="article:modified_time" content="2022-09-23T12:34:00+09:00">
<meta property="og:image" content="https://xrzhev.com/posts/2022-09-22/img/ogp/index.webp">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="mitmproxyにおけるリクエスト編集の末尾改行文字の仕様">
<meta name=twitter:description content="mitmproxyを使っていて「ん？」となる挙動があったので備忘として記録します。">
<meta name=twitter:image content="https://xrzhev.com/posts/2022-09-22/img/ogp/index.webp">
<link rel=stylesheet href=https://xrzhev.com/css/styles.bffb01f49c32dfc08ab4bab122ea7a283cac2fb1be2e0ed85c8927eeff6b4431c3302f1bf04324ac1a7a255fabef5a2dcd172d756ee959224dc671c4db1f7af1.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]-->
<link rel=icon type=image/png href=https://xrzhev.com/images/favicon.ico>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-M0JBLYFQ0B"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-M0JBLYFQ0B',{anonymize_ip:!1})}</script>
</head>
<body class="max-width mx-auto px3 ltr">
<div class="content index py4">
<div id=header-post>
<a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast')" style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu>
<span id=nav>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>Posts</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/tags>Tags</a></li>
<li><a href=/index.xml>Rss</a></li>
</ul>
</span>
<br>
<span id=actions>
<ul>
<li>
<a class=icon href=https://xrzhev.com/posts/2022-08-11/ aria-label=Previous>
<i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle()" onmouseout="$('#i-prev').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page">
<i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle()" onmouseout="$('#i-top').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=# aria-label=Share>
<i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle()" onmouseout="$('#i-share').toggle()" onclick="return $('#share').toggle(),!1"></i>
</a>
</li>
</ul>
<span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span>
</span>
<br>
<div id=share style=display:none>
<ul>
<li>
<a class=icon href="https://twitter.com/share?url=https%3a%2f%2fxrzhev.com%2fposts%2f2022-09-22%2f&text=mitmproxy%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e7%b7%a8%e9%9b%86%e3%81%ae%e6%9c%ab%e5%b0%be%e6%94%b9%e8%a1%8c%e6%96%87%e5%ad%97%e3%81%ae%e4%bb%95%e6%a7%98" aria-label=Twitter>
<i class="fab fa-twitter" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fxrzhev.com%2fposts%2f2022-09-22%2f&title=mitmproxy%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e7%b7%a8%e9%9b%86%e3%81%ae%e6%9c%ab%e5%b0%be%e6%94%b9%e8%a1%8c%e6%96%87%e5%ad%97%e3%81%ae%e4%bb%95%e6%a7%98" aria-label=Linkedin>
<i class="fab fa-linkedin" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="mailto:?subject=mitmproxy%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e7%b7%a8%e9%9b%86%e3%81%ae%e6%9c%ab%e5%b0%be%e6%94%b9%e8%a1%8c%e6%96%87%e5%ad%97%e3%81%ae%e4%bb%95%e6%a7%98&body=Check out this article: https%3a%2f%2fxrzhev.com%2fposts%2f2022-09-22%2f" aria-label=Email>
<i class="fas fa-envelope" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fxrzhev.com%2fposts%2f2022-09-22%2f&title=mitmproxy%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e7%b7%a8%e9%9b%86%e3%81%ae%e6%9c%ab%e5%b0%be%e6%94%b9%e8%a1%8c%e6%96%87%e5%ad%97%e3%81%ae%e4%bb%95%e6%a7%98" aria-label=Pocket>
<i class="fab fa-get-pocket" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fxrzhev.com%2fposts%2f2022-09-22%2f&title=mitmproxy%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e7%b7%a8%e9%9b%86%e3%81%ae%e6%9c%ab%e5%b0%be%e6%94%b9%e8%a1%8c%e6%96%87%e5%ad%97%e3%81%ae%e4%bb%95%e6%a7%98" aria-label=reddit>
<i class="fab fa-reddit" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fxrzhev.com%2fposts%2f2022-09-22%2f&t=mitmproxy%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e7%b7%a8%e9%9b%86%e3%81%ae%e6%9c%ab%e5%b0%be%e6%94%b9%e8%a1%8c%e6%96%87%e5%ad%97%e3%81%ae%e4%bb%95%e6%a7%98" aria-label="Hacker News">
<i class="fab fa-hacker-news" aria-hidden=true></i>
</a>
</li>
</ul>
</div>
<div id=toc>
<nav id=TableOfContents>
<ul>
<li><a href=#詰まったポイント>詰まったポイント</a>
<ul>
<li><a href=#問題となる仕様>問題となる仕様</a></li>
</ul>
</li>
<li><a href=#修正方法>修正方法</a>
<ul>
<li><a href=#修正したバージョン>修正したバージョン</a></li>
<li><a href=#修正箇所>修正箇所</a></li>
</ul>
</li>
<li><a href=#おわりに>おわりに</a></li>
</ul>
</nav>
</div>
</span>
</div>
<article class=post itemscope itemtype=http://schema.org/BlogPosting>
<header>
<h1 class=posttitle itemprop="name headline">
mitmproxyにおけるリクエスト編集の末尾改行文字の仕様
</h1>
<div class=meta>
<div class=postdate>
投稿日: <time datetime="2022-09-22 16:14:52 +0900 +0900" itemprop=datePublished>2022-09-22 16:14</time>
</div>
<div class=lastmoddate>
最終更新日: <time datetime="2022-09-23 12:34:00 +0900 +0900" itemprop=dateModified>2022-09-23 12:34</time>
</div>
<div class=article-category>
<i class="fas fa-archive"></i>
<a class=category-link href=/categories/%E9%9B%91%E8%A8%98>雑記</a>
</div>
<div class=article-tag>
<i class="fas fa-tag"></i>
<a class=tag-link href=/tags/%E3%83%84%E3%83%BC%E3%83%AB rel=tag>ツール</a>
,
<a class=tag-link href=/tags/%E5%82%99%E5%BF%98 rel=tag>備忘</a>
,
<a class=tag-link href=/tags/mitmproxy rel=tag>mitmproxy</a>
</div>
</div>
</header>
<div class=content itemprop=articleBody>
<p>mitmproxyを使っていて「ん？」となる挙動があったので備忘として記録します。</p>
<h2 id=詰まったポイント>詰まったポイント</h2>
<p>mitmproxyではhttp, https通信以外にも生のTCPペイロードをインターセプトして値を編集、それらを送信することができます。<br>
http以外のTCPで通信をするアプリケーションの通信部分のデバッギングに非常に便利なのですが、mitmproxyには一部のユーザーにとって初見殺しに近い仕様が隠されていました。</p>
<h3 id=問題となる仕様>問題となる仕様</h3>
<p><strong>TCPペイロードをインターセプトし、インターセプトしたリクエスト/レスポンスを編集すると末尾の改行文字が削除される</strong>という点です。</p>
<p>TCPペイロード以外にもHTTPなどではインターセプトした際、ヘッダなどをmitmproxy上で自動認識してある程度区分けされた状態でリクエスト/レスポンスの編集を行うことができます。<br>
そのような場合では改行文字などはmitmproxy上で自動で付与されるため、通常であれば問題は発生しません。</p>
<p>TCPペイロードの場合、アプリケーションによっては末尾に改行文字を含ませてリクエスト/レスポンスを送受信することがあります。<br>
しかしながら、mitmproxyには末尾に改行文字が含まれているTCPペイロードを編集して送信する際、元のリクエスト/レスポンスに付与されていたTCPペイロードの改行文字が抜け落ちてしまう事象が存在します。</p>
<p>今回は改行文字が抜け落ちてしまうことで、アプリケーション側の処理がストップしてしまう事象に遭遇しました。</p>
<p><img src=./img/details.webp alt=事象概要></p>
<p>修正自体は簡単なので、以下に修正方法を記載します。</p>
<h2 id=修正方法>修正方法</h2>
<h3 id=修正したバージョン>修正したバージョン</h3>
<p>実行バイナリではなく、pip3でインストールしたバージョンです。</p>
<pre tabindex=0><code>Mitmproxy: 8.1.1
Python:    3.10.4
OpenSSL:   OpenSSL 3.0.5 5 Jul 2022
Platform:  Linux-5.15.0-47-generic-x86_64-with-glibc2.35
</code></pre><h3 id=修正箇所>修正箇所</h3>
<p>対象: <code>~/.local/lib/python3.10/site-packages/mitmproxy/tools/console/consoleaddons.py</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py3 data-lang=py3><span style=color:#ae81ff>450</span>         <span style=color:#66d9ef>elif</span> flow_part <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;tcp-message&#34;</span>:
<span style=color:#ae81ff>451</span>             message <span style=color:#f92672>=</span> flow<span style=color:#f92672>.</span>messages[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
<span style=color:#ae81ff>452</span>             c <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>master<span style=color:#f92672>.</span>spawn_editor(message<span style=color:#f92672>.</span>content <span style=color:#f92672>or</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;&#34;</span>)
<span style=color:#ae81ff>453</span>             <span style=color:#75715e>#message.content = c.rstrip(b&#34;\n&#34;)</span>
<span style=color:#ae81ff>454</span>             message<span style=color:#f92672>.</span>content <span style=color:#f92672>=</span> c
</code></pre></div><p>453行目でインターセプトしたリクエスト/レスポンスを編集したあとの文字列から末尾改行文字を捨てているため、これをコメントアウトしてrstripしていないデータを返せばOKです。</p>
<h2 id=おわりに>おわりに</h2>
<p>謎の挙動すぎて初めは困惑したけどソース見たら一発でしたね…。<br>
さすがにアレなのでプルリク送ろうと思ったんですが、修正したソースコードの上のほうにこんなことが書いてあり、送るのをやめました。</p>
<pre tabindex=0><code># Many editors make it hard to save a file without a terminating
# newline on the last line. When editing message bodies, this can
# cause problems. We strip trailing newlines by default, but this
# behavior is configurable.
</code></pre><p>エディタの挙動にもよるらしく、改行の切り捨てを安易に行うのは全体的に見るとよくなさそうな感じがします。<br>
mitmproxyを使う人間なら自分で直せという雰囲気を感じました。</p>
</div>
</article>
<div id=footer-post-container>
<div id=footer-post>
<div id=nav-footer style=display:none>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>Posts</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/tags>Tags</a></li>
<li><a href=/index.xml>Rss</a></li>
</ul>
</div>
<div id=toc-footer style=display:none>
<nav id=TableOfContents>
<ul>
<li><a href=#詰まったポイント>詰まったポイント</a>
<ul>
<li><a href=#問題となる仕様>問題となる仕様</a></li>
</ul>
</li>
<li><a href=#修正方法>修正方法</a>
<ul>
<li><a href=#修正したバージョン>修正したバージョン</a></li>
<li><a href=#修正箇所>修正箇所</a></li>
</ul>
</li>
<li><a href=#おわりに>おわりに</a></li>
</ul>
</nav>
</div>
<div id=share-footer style=display:none>
<ul>
<li>
<a class=icon href="https://twitter.com/share?url=https%3a%2f%2fxrzhev.com%2fposts%2f2022-09-22%2f&text=mitmproxy%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e7%b7%a8%e9%9b%86%e3%81%ae%e6%9c%ab%e5%b0%be%e6%94%b9%e8%a1%8c%e6%96%87%e5%ad%97%e3%81%ae%e4%bb%95%e6%a7%98" aria-label=Twitter>
<i class="fab fa-twitter fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fxrzhev.com%2fposts%2f2022-09-22%2f&title=mitmproxy%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e7%b7%a8%e9%9b%86%e3%81%ae%e6%9c%ab%e5%b0%be%e6%94%b9%e8%a1%8c%e6%96%87%e5%ad%97%e3%81%ae%e4%bb%95%e6%a7%98" aria-label=Linkedin>
<i class="fab fa-linkedin fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="mailto:?subject=mitmproxy%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e7%b7%a8%e9%9b%86%e3%81%ae%e6%9c%ab%e5%b0%be%e6%94%b9%e8%a1%8c%e6%96%87%e5%ad%97%e3%81%ae%e4%bb%95%e6%a7%98&body=Check out this article: https%3a%2f%2fxrzhev.com%2fposts%2f2022-09-22%2f" aria-label=Email>
<i class="fas fa-envelope fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fxrzhev.com%2fposts%2f2022-09-22%2f&title=mitmproxy%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e7%b7%a8%e9%9b%86%e3%81%ae%e6%9c%ab%e5%b0%be%e6%94%b9%e8%a1%8c%e6%96%87%e5%ad%97%e3%81%ae%e4%bb%95%e6%a7%98" aria-label=Pocket>
<i class="fab fa-get-pocket fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fxrzhev.com%2fposts%2f2022-09-22%2f&title=mitmproxy%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e7%b7%a8%e9%9b%86%e3%81%ae%e6%9c%ab%e5%b0%be%e6%94%b9%e8%a1%8c%e6%96%87%e5%ad%97%e3%81%ae%e4%bb%95%e6%a7%98" aria-label=reddit>
<i class="fab fa-reddit fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fxrzhev.com%2fposts%2f2022-09-22%2f&t=mitmproxy%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e7%b7%a8%e9%9b%86%e3%81%ae%e6%9c%ab%e5%b0%be%e6%94%b9%e8%a1%8c%e6%96%87%e5%ad%97%e3%81%ae%e4%bb%95%e6%a7%98" aria-label="Hacker News">
<i class="fab fa-hacker-news fa-lg" aria-hidden=true></i>
</a>
</li>
</ul>
</div>
<div id=actions-footer>
<a id=menu-toggle class=icon href=# onclick="return $('#nav-footer').toggle(),!1" aria-label=Menu>
<i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick="return $('#toc-footer').toggle(),!1" aria-label=TOC>
<i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick="return $('#share-footer').toggle(),!1" aria-label=Share>
<i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page">
<i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a>
</div>
</div>
</div>
<footer id=footer>
<div class=footer-left>
Copyright &copy; 2022 xrzhev
</div>
<div class=footer-right>
<nav>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>Posts</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/tags>Tags</a></li>
<li><a href=/index.xml>Rss</a></li>
</ul>
</nav>
</div>
</footer>
</div>
</body>
<link rel=stylesheet href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>
</html>